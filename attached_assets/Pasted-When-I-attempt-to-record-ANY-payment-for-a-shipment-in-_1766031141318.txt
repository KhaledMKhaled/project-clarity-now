When I attempt to record ANY payment for a shipment in either status:
- “New” (شحنة جديدة)
or
- “Received” (مستلمة)
or
- any status 

the system throws an error saying that the following “missing data” is required:
- Goods cost (تكلفة البضائع)
- Customs (الجمارك)
- Takhreeg (التخريج)
- Shipping (الشحن)
- Commission (العمولة)

However, this business rule is WRONG for our workflow:
✅ We MUST be able to pay part of a shipment immediately after creating it, even before shipping/customs/takhreeg are completed or entered.
✅ The ONLY restriction is: you cannot pay more than the currently allowed amount at the time of payment (no overpayment).
So payments should be allowed with partial cost data, based on what is known/entered so far.

REQUEST:
1) Fix the payment validation logic so it does NOT require all cost components to exist before allowing a payment.
2) Implement correct “allowed payable amount” logic that supports partial costs and prevents overpayment.
3) Update error messages to be clear and accurate (no misleading “missing data” list).
4) Ensure balances/totals remain consistent across shipments, payments, dashboards, accounting reports, and audit logs.

============================================================
NON-NEGOTIABLE RULES (MUST PRESERVE)
============================================================

- Authentication: Passport local login, Postgres session store; secure cookies in production.
- Authorization: isAuthenticated + requireRole; isAdmin for Manager-only.
- Payments integrity:
  - Validate payload (including paymentDate parsing)
  - Prevent overpayment
  - Update shipment totals atomically: totalPaid, balance, lastPaymentDate
  - Handle currencies correctly (EGP/RMB; exchange rates when required)
  - Record creator; audit-log key mutations
- Do NOT bypass validation entirely. Replace incorrect validation with correct rules.

============================================================
DESIRED BUSINESS LOGIC (IMPORTANT)
============================================================

A) Payments are allowed at ANY shipment stage (new, awaiting shipping, ready for pickup, received).
B) Missing cost components should NOT block payments.
C) Overpayment prevention must be based on the shipment’s “currently known total payable”:
- Known total = sum of cost components that are currently entered/available
  (e.g., goods cost may exist on creation; shipping/customs/takhreeg may be 0 or null until later)
- Allowed to pay up to: max(0, knownTotal - totalPaidSoFar)
- Payment must be rejected if paymentAmount > remainingAllowed
D) If knownTotal is 0 or not computable because even goods cost is missing, payments may still be allowed ONLY if your system supports “deposit/advance payments”.
   - If advance payments are allowed in your system, define a clear rule:
     - Either allow paying with no known total but cap by a separate “deposit limit” field
     - Or require at least one cost component (goods cost) to be present
   - Decide based on existing FodaStore conventions in code and preserve consistency.

============================================================
WHAT YOU MUST DO
============================================================

STEP 1 — Understanding Summary (Before Coding)
Write a short summary confirming:
- The current wrong error behavior (“missing data: goods/customs/takhreeg/shipping/commission”)
- The correct desired behavior (partial payments allowed immediately)
- The true restriction (no overpayment beyond currently known payable amount)
List 5–10 likely root causes, e.g.:
- Payment endpoint incorrectly validates required cost fields
- Shipment finalTotal is required but not computed early
- Null vs 0 handling makes system think fields are missing
- UI sends wrong shipmentId or stale status
- Remaining calculation uses “finalTotal only” instead of “knownTotal”

STEP 2 — Locate the exact validation and fix it
- Identify where the “missing data” message is generated (backend preferred).
- Replace “require all cost fields” with “compute knownTotal from available fields”.
- Ensure null-safe numeric computation:
  - treat null/undefined as 0 for optional components
  - do not treat optional missing fields as fatal

STEP 3 — Implement correct remaining / overpayment logic
- Compute remainingAllowed using currently known totals and already-paid amounts
- Block if payment would exceed remainingAllowed
- Return a clear error message like:
  - “Payment exceeds the remaining allowed amount based on currently recorded costs.”
  - Include details: knownTotal, totalPaid, remainingAllowed, attemptedAmount

STEP 4 — Update UI + Error Messages
- Ensure frontend displays the server’s message clearly.
- Remove misleading “missing cost components” lists unless they are truly required.
- If something is truly required (e.g., shipment not found, invalid date, missing RMB rate), show an actionable message.

STEP 5 — Verify End-to-End Consistency
Confirm after the fix:
- Payments save correctly for new and received shipments
- Shipment totalPaid/balance/lastPaymentDate updates atomically
- Dashboards/accounting reports remain correct
- Audit logs record successful payment actions (user, shipment, amount, currency, resulting totals)

STEP 6 — Add Tests (Required)
Add automated tests covering:
- Payment allowed immediately after shipment creation with only goods cost present
- Payment allowed when shipping/customs/takhreeg are still null/0
- Overpayment blocked correctly based on knownTotal
- RMB payment requires rate handling (if that is an invariant)
- Atomicity: payment + shipment totals update transactionally

============================================================
DELIVERABLES
============================================================

1) Root cause explanation (why validation demanded all cost components).
2) Code changes (files changed + key diffs).
3) Updated/standardized error responses (consistent JSON shape; clear messages).
4) Testing instructions (manual + automated).
5) Confirmation checklist for linkage and correctness across related screens.

Start now by writing the Understanding Summary and investigation plan, then implement the fix.
